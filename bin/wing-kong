#!/usr/bin/env node
const yargs = require('yargs/yargs');
const fs = require('fs');
const { hideBin } = require('yargs/helpers');
const packageData = require('../package.json')
const { createImportMap } = require('../wing-kong.js');
const path = require('path');
yargs(hideBin(process.argv))
    .command('generate [mode]', 'create new importmap', (yargs) => {
        return yargs.positional('mode', {
            describe: 'generate modes',
            default: 'dependencies'
        })
    }, async (argv) => {
        const parts = argv.mode.split('+');
        let map = {};
        parts.forEach((part)=>{
            map = {...map, ...(packageData[part] || {})}
        });
        const config = argv.i?require(path.join('..', argv.i)):{ "local" : "/node_modules/${name}/"};
        const importMap = await createImportMap(map, config);
        const result = JSON.stringify(importMap, null, '    ');
        if(argv.f){
          fs.writeFile(argv.f, result, {}, ()=>{
              console.log(`File "${argv.f}" written.`);
          });
        }else{
            console.log(result);
        }
    })
    .option('file', {
        alias: 'f',
        type: 'string',
        description: 'output to file'
    })
    .option('imports', {
      alias: 'i',
      type: 'string',
      description: 'import endpoint map'
    })
    .help('help')
  .parse();